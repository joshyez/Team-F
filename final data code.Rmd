---
title: "Untitled"
author: "Ngodoo Zume"
date: "8/9/2020"
output:
html_document:
    code_folding: hide
    # number_sections: true
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '3'
---

```{r basicfunct, include=FALSE}
loadPkg = function(x) { if (!require(x,character.only=T, quietly =T)) { install.packages(x,dep=T,repos="http://cran.us.r-project.org"); if(!require(x,character.only=T)) stop("Package not found") } }
unloadPkg = function(pkg, character.only = FALSE) { 
  if(!character.only) { pkg <- as.character(substitute(pkg)) } 
  search_item <- paste("package", pkg,sep = ":") 
  while(search_item %in% search()) { detach(search_item, unload = TRUE, character.only = TRUE) } 
}
```
```{r}
loadPkg("ggplot2") 
state_data <- read.csv("state_data.csv")
data_by_state <- read.csv("data_by_state.csv")
```

#1. Introduction


##1.1 Index
This report is organized as follows: 
1. Introduction
1.1 Index
2. Description of the Data
2.1 Source Data
2.2 Variables
2.3 Geographical Description of the Data
3. Analysis
3.1 Multiple Linear Regression Model
3.2 Two Sample T-Test
3.3 Linear Regression 
3.4 Anova 
4. Conclusion
5. Citations

#2. Description of the Data 
##2.1 Source Data

##2.2 Variables

##2.3 Geographical Description of the Data 

The graph below shows an overall trend of confirmed covid-19 cases and deaths from 05/01/2020 to 07/18/2020 in the US. The top of each vertical line represents the highest number of cases or deaths in a state at the time period. We can see the daily confirmed cases and deaths are increasing continuously. And from another graph we can see tests and recoveries are increasing obviously.
```{r,echo=FALSE,message = FALSE}
loadPkg("tidyr")
loadPkg("usmap")
loadPkg("readr")
loadPkg("ggplot2")
loadPkg("dplyr")
loadPkg("scales")
covid=read.csv("state_data_add.csv")
str(covid)
ks=function (x) { number_format(accuracy = 1,
                                   scale = 1/1000,
                                   suffix = "k",
                                   big.mark = ",")(x) }
df=covid %>%
  select(date,cases,deaths) %>%
  gather(key = "variable", value = "value", -date)
df$date=as.Date(df$date,format = "%m/%d/%y")
ggplot(df, aes(x = date, y = value)) + 
  geom_area(aes(color = variable,fill = variable), 
            alpha = 0.5, position = position_dodge(0.8))+ggtitle("Covid-19 data from 05/01/2020 to 07/18/2020 in US")+scale_color_manual(values = c("blue","red")) +scale_fill_manual(values = c("blue","red"))+scale_y_continuous(labels = ks)
```

```{r,results='markup'}
dfa=covid %>%
  select(date,cases,deaths,hospitalized,recovered,tests) %>%
  gather(key = "variable", value = "value", -date)
dfa$date=as.Date(dfa$date,format = "%m/%d/%y")
ggplot(dfa, aes(x = date, y = value)) + 
  geom_area(aes(color = variable,fill = variable), 
            alpha = 0.5, position = position_dodge(0.8))+ggtitle("Covid-19 data from 05/01/2020 to 07/18/2020 in US")+scale_color_manual(values = c("blue","red","green","black","orange")) +scale_fill_manual(values = c("blue","red","green","black","orange"))+scale_y_continuous(labels = ks)
```


The graph of "confirmed cases in the US until 07/18/2020" shows that New York, California, Florida, and Texas are the top four states that have the most positive cases. New York has passed 400k confirmed Covid-19 cases until 07/18/2020. California, Florida, and Texas are between 300k to 400k cases. Other states are below 200k. 
```{r,,results='markup',warning=FALSE}
covid_cum=subset(covid,date=="7/18/20")
ggplot(covid_cum,aes(x=state,y=cases,color=state))+geom_point()+ggtitle("Confirmed Coronavirus Cases until 07/18/2020 in US")+geom_text(aes(label=state))+scale_y_continuous(labels = ks)
plot_usmap(data = covid_cum, labels=TRUE, values = "cases", color = "red") + 
  scale_fill_continuous(
    low = "white", high = "red", name = "Confirmed Coronavirus Cases until 07/18/2020 in US", label = scales::comma
  ) + theme(legend.position = "right")
```


The graph of "deaths in the US until 07/18/2020" shows that New York has most deaths.  More than 30k people are dead in New York and around 15k people are dead in New Jersey until 07/18/2020. Other states are below 10k. But this only can represent the result in this time period, New York has more people infected earlier, so they may have more people dead earlier. 
```{r,results='markup',warning=FALSE}
ggplot(covid_cum,aes(x=state,y=deaths,color=state))+geom_point()+ggtitle("Deaths from Coronavirus until 07/18/2020 in US")+geom_text(aes(label=state))+scale_y_continuous(labels = ks)
plot_usmap(data = covid_cum, labels=TRUE, values = "deaths", color = "red") +
  scale_fill_continuous(
    low = "white", high = "red", name = "Deaths from Coronavirus from 05/01/2020 to 07/18/2020 in US", label = scales::comma
  ) + theme(legend.position = "right")
```


The heat map of the US population shows that California, Texas, Florida, and New York are the four states that have the most population. They are also the four states that have the most confirmed cases. 
```{r,echo=FALSE,warning=FALSE}
ggplot(covid_cum,aes(x=state,y=population,color=state))+geom_point()+ggtitle("Population of each state in US")+geom_text(aes(label=state))+scale_y_continuous(labels = ks)
plot_usmap(data=covid_cum, labels=TRUE, values="population",color="green")+
  scale_fill_continuous(
    low = "white", high = "green", name = "Population of each state in US", label = scales::comma
  ) + theme(legend.position = "right")
```


The heat map below shows the parties of each state based on the 2018 data. We can see that two of the states that have the most confirmed cases and most population, which is New York and California, are demoncratic states. And two of the states that have the most confirmed cases and most populated, which is Florida and Texas, are republican states. So we will have some analysis based on these four states.
```{r,echo=FALSE,warning=FALSE}
plot_usmap(data=covid, labels=TRUE, values="party",color="red")
```


The graph of the number of tests shows that California has more than 6 million tests until 7/18/2020 and New York has around 5 million tests. The republican states, Florida and Texas, are below them and have around 3 million tests. Until 7/18, the two republican states have tests much below the two democratic states, they may have more tests in the future, but they have much more people who have not tested until 7/18. 
```{r,results='markup',warning=FALSE}
ggplot(covid_cum,aes(x=state,y=tests,color=state))+geom_point()+ggtitle("Number of tests of each state in US")+geom_text(aes(label=state))+scale_y_continuous(labels = ks)
plot_usmap(data=covid_cum, labels=TRUE, values="tests",color="orange")+
  scale_fill_continuous(
    low = "white", high = "orange", name = "Number of tests of each state in US", label = scales::comma
  ) + theme(legend.position = "right")
```


The graph of cumulative hospitalization until 7/18 shows that New York is the state that has the most people hospitalized. Because California and Texas are missing data, I will compare the two states that have the most confirmed cases, New York and Florida. Whereas democratic state New York has more than 75k people are hospitalized, republican state Florida has below 25k people are hospitalized.  
```{r,results='markup',warning=FALSE}
ggplot(covid_cum,aes(x=state,y=hospitalized,color=state))+geom_point()+ggtitle("Hospitalization in each states")+geom_text(aes(label=state))+scale_y_continuous(labels = ks)
```


#3. Analysis

##3.1 Plot Analysis

In order to better compare the two republican states and democratic states, the line plots below are generated. We can see the lines of confirmed cases in Republican states Florida and Texas are going up more sharply than democratic states New York and California. They may have more chances to increase cases greatly in the future. And although the two republican states have the number of tests much lower than the two democratic states, they donâ€™t show a sign that they will have many more people get tested in the future. 

```{r,results='markup',warning=FALSE}
covidny=subset(covid,state=="NY")
df1=covidny %>%
  select(date,cases, deaths,hospitalized,tests,recovered) %>%
  gather(key = "variable", value = "value", -date)
df1$date=as.Date(df1$date,format = "%m/%d/%y")
ggplot(df1, aes(x = date, y = value)) + 
  geom_line(aes(color = variable), size = 1) +
  scale_color_manual(values = c("blue", "red","green","yellow","orange")) +
  theme_minimal()+scale_y_continuous(labels = ks)+ggtitle("Covid-19 data in NY")
```

```{r,results='markup',warning=FALSE}
covidtx=subset(covid,state=="TX")
df2=covidtx %>%
  select(date,cases, deaths,hospitalized,tests,recovered) %>%
  gather(key = "variable", value = "value", -date)
df2$date=as.Date(df2$date,format = "%m/%d/%y")
ggplot(df2, aes(x = date, y = value)) + 
  geom_line(aes(color = variable), size = 1) +
  scale_color_manual(values = c("blue", "red","green","yellow","orange")) +
  theme_minimal()+scale_y_continuous(labels = ks)+ggtitle("Covid-19 data in TX")
```
```{r,results='markup',warning=FALSE}
covidfl=subset(covid,state=="FL")
df3=covidfl %>%
  select(date,cases, deaths,hospitalized,tests,recovered) %>%
  gather(key = "variable", value = "value", -date)
df3$date=as.Date(df3$date,format = "%m/%d/%y")
ggplot(df3, aes(x = date, y = value)) + 
  geom_line(aes(color = variable), size = 1) +
  scale_color_manual(values = c("blue", "red","green","yellow","orange")) +
  theme_minimal()+scale_y_continuous(labels = ks)+ggtitle("Covid-19 data in FL")
```

```{r,results='markup',warning=FALSE}
covidca=subset(covid,state=="CA")
df4=covidca %>%
  select(date,cases, deaths,hospitalized,tests,recovered) %>%
  gather(key = "variable", value = "value", -date)
df4$date=as.Date(df4$date,format = "%m/%d/%y")
ggplot(df4, aes(x = date, y = value)) + 
  geom_line(aes(color = variable), size = 1) +
  scale_color_manual(values = c("blue", "red","green","yellow","orange")) +
  theme_minimal()+scale_y_continuous(labels = ks)+ggtitle("Covid-19 data in CA")
```


The data in the four states may not be enough to show that some democratic states are doing better than republican states. Since demoncratic states New Jersey and Illinois are the fifth and sixth states that have the most confirmed cases, republican states Georgia and Arizona are the seventh and eighth states that have the most cases, we picked these four states to generate another analysis. The lines of confirmed cases in the demoncratic states New Jersey and Illinois are much more stable than republican states Georgia and Arizona. Georgia and Arizona are more possible to increase confirmed cases largely in the future. And Georgia and Arizona are also  conducted tests lower than New Jersey and Illinois. Moreover, New Jersey has more people hospitalized than Georgia and Arizona. By comparing the eight states, we can see some demoncratic states control the increasing cases better than some republican states.
```{r,results='markup',warning=FALSE}
covidil=subset(covid,state=="IL")
df5=covidil %>%
  select(date,cases, deaths,hospitalized,tests,recovered) %>%
  gather(key = "variable", value = "value", -date)
df5$date=as.Date(df5$date,format = "%m/%d/%y")
ggplot(df5, aes(x = date, y = value)) + 
  geom_line(aes(color = variable), size = 1) +
  scale_color_manual(values = c("blue", "red","green","yellow","orange")) +
  theme_minimal()+scale_y_continuous(labels = ks)+ggtitle("Covid-19 data in IL")
```

```{r,results='markup',warning=FALSE}
covidnj=subset(covid,state=="NJ")
df6=covidnj %>%
  select(date,cases, deaths,hospitalized,tests,recovered) %>%
  gather(key = "variable", value = "value", -date)
df6$date=as.Date(df6$date,format = "%m/%d/%y")
ggplot(df6, aes(x = date, y = value)) + 
  geom_line(aes(color = variable), size = 1) +
  scale_color_manual(values = c("blue", "red","green","yellow","orange")) +
  theme_minimal()+scale_y_continuous(labels = ks)+ggtitle("Covid-19 data in NJ")
```

```{r,results='markup',warning=FALSE}
covidga=subset(covid,state=="GA")
df7=covidga %>%
  select(date,cases, deaths,hospitalized,tests,recovered) %>%
  gather(key = "variable", value = "value", -date)
df7$date=as.Date(df7$date,format = "%m/%d/%y")
ggplot(df7, aes(x = date, y = value)) + 
  geom_line(aes(color = variable), size = 1) +
  scale_color_manual(values = c("blue", "red","green","yellow","orange")) +
  theme_minimal()+scale_y_continuous(labels = ks)+ggtitle("Covid-19 data in GA")
```

```{r,results='markup',warning=FALSE}
covidaz=subset(covid,state=="AZ")
df8=covidaz %>%
  select(date,cases, deaths,hospitalized,tests,recovered) %>%
  gather(key = "variable", value = "value", -date)
df8$date=as.Date(df8$date,format = "%m/%d/%y")
ggplot(df8, aes(x = date, y = value)) + 
  geom_line(aes(color = variable), size = 1) +
  scale_color_manual(values = c("blue", "red","green","yellow","orange")) +
  theme_minimal()+scale_y_continuous(labels = ks)+ggtitle("Covid-19 data in AZ")
```


##3.2 Two Sample T-Test

*In this section, the focus will be on the relationship between political party affiliation and the average change in Covid-19 cases, from May 1, 2020 to July 18, 2020.  The average change in cases is per 1,000 people to better visualize how the number of cases has changed over time and to make the states more comparable. Figures 1 and 2 below will be used to visually evaluate the data for potential relationships or patterns between the average change in cases and political party affiliation.*

```{r, echo=FALSE}
ggplot(data_by_state, aes(x=Party, y=avg_change, fill = Party, na.action())) + 
  geom_boxplot() + scale_fill_manual(values = c("blue", "red")) +labs(title="Plot of Avg change in Cases \n by Party",
        x ="Political Party", y = "Avg Change in Covid-19 Cases (per 1,000)") + theme( plot.title = element_text(hjust = 0.5,  size=14, face="bold")) 
```

*Figure 1: Boxplot of the average change in cases by party* 

*The boxplot in figure 1, shows that republican states have experienced a greater increase in Covid-19 cases than democratic states, on average. It is important to note that the variation in republican states is also greater. Not only is the mean higher for this group, but it also appears to have more states that have experienced a greater increase in cases. This is most likely what is causing the larger variation.*

```{r, echo=FALSE}
ggplot(data=data_by_state, aes(x=reorder(State, -avg_change), y=avg_change, fill=Party)) + ggtitle("Avg Change in Covid-19 Cases \n by State and Political Affiliation") +
  xlab("State") + ylab("Avg Change in Cases (per 1,000)") +
  geom_bar(stat="identity") + scale_fill_manual(values = c("blue", "red")) + theme(axis.text.x=element_text(angle=90, hjust=1), plot.title = element_text(hjust = 0.5,  size=14, face="bold"))
```

*Figure 2: Bar graph of the average change in cases by state and political affiliation*

*Figure 2 serves as a visualization of the growth in cases, across all states. The graph is in descending order, to better focus on those with the highest rates. The two states to have experienced the largest average surge in Covid-19 cases are republican states â€“ Arizona and Florida. When we focus on the 10 states with the highest average growth in cases, it is evident that the majority are republican states.  From the ten, Nevada is the only democratic state.* 

*To test if the mean difference in average change in cases between the two parties is statistically zero, the Welch two-sample t-test will be used. This specific test is being used because the two samples do not have the same sample size and it is more robust to the equal variance assumption than the student t-test. If the variances were equal, it would still give us the same result as a student t-test.*

*The null hypothesis is that there is no difference between the two means and the alternative hypothesis is that democratic states have a lower average change in number of cases than republican states.*  

$H_o: Î¼_d= Î¼_r$

$H_a: Î¼_d< Î¼_r$

*With this approach, there are two preliminary tests used to check the testâ€™s assumptions: independence and normality.*
1.Independence:
Each state can only be affiliated with one political party. Therefore, the two samples from democratic and republican states are independent.

2.Normality:

```{r, echo=FALSE}
qqnorm(data_by_state$avg_change)
```

*Figure 3: Normal Q-Q Plot*
*From the visual check in Figure 3, the QQ-plot appears to be normal. Now, the Shapiro-Wilke test will be used to confirm:*

```{r, echo=FALSE}
with(data_by_state, shapiro.test(avg_change[Party == "rep"]))# p = 0.8837
with(data_by_state, shapiro.test(avg_change[Party == "dem"])) # p = 0.9927
```

*Figure 4: Shapiro-Wilk Normality Test*

*The p-value > 0.05 for both groups, so we fail to reject the null hypothesis that the sample belongs to a normal distribution. Hence, we can conclude that both distributions are normal.*
*As a result of all the necessary assumptions being met, the use of the Welch two-sample t-test has been justified and we can continue with the analysis.*

```{r, echo=FALSE}
results <- t.test(avg_change~Party, data = data_by_state, alternative = "less")
results
```

*Figure 5: Welch Two Sample T-Test (One Sided Test))*

*After conducting the t-test, the results show that the p-value = 0.059, which is greater than 0.05. This implies the failure to reject the null hypothesis that the means are equal. Therefore, we can conclude that between May 1, 2020 and July 18, 2020, the average change in Covid-19 cases was not significantly higher for republican states, compared to democratic states.*


##3.3 Linear Regression 
```{r, include=FALSE}
#Remove outliers from cases and deaths per thousand 
data_by_state_clean<- outlierKD2(data_by_state, Cases.per.thou, TRUE)
data_by_state_clean<- outlierKD2(data_by_state, Deaths.per.thou, TRUE)
```
```{r, include=FALSE}
#Subset republican and dem data 
rep_data1 <- subset(data_by_state_clean, Party == "Republican")
dem_data1 <- subset(data_by_state_clean, Party == "Democratic")
```
```{r}
#linear model cases v deaths

library(ggplot2)
 
ggplot(data_by_state_clean, aes(x=Cases.per.thou, y=Deaths.per.thou, color=Party))+ geom_point()+labs(title="Scatterplot", subtitle = "Deaths vs Cases", x= "Cases (per 1,000)", y= "Deaths (per 1,000)") +geom_smooth(method = "lm" )+ scale_color_manual(values=c("red", "blue"))+ xlim(c(0,850))+ ylim(c(0,50))

```
Next, we wanted to look at the relationship between COVID related deaths and the number of cases. More specifically, do deaths trend with cases and what does that trend look like for each party? In this section we are factoring in population by the thousands and have removed outliers to decrease variability and increase statistical power. To analyze this relationship, we created a scatterplot formatted with a line of best fit. The line of best fit follows the equation Å· = bX + a, where b is the slope of the line and a is the intercept, which allows us to estimate the dependent variable (deaths), given the independent variable (cases). We would assume, as a stateâ€™s number of cases  increases, so should its number of deaths, providing a positive trend, which is observed in our model. This graph shows an increased number of democratic states with higher case and death occurrences. We also see that the rate of deaths per case for both parties look similar. 

```{r}
#Correlation
cor.test(rep_data1$Cases.per.thou, rep_data1$Deaths.per.thou, method = "pearson", conf.level = 0.95)
```
```{r}
cor.test(dem_data1$Cases.per.thou, dem_data1$Deaths.per.thou, method = "pearson", conf.level = 0.95)
```
To analyze the relationship between cases and deaths among both parties we completed a Pearson's correlation test, which measures the strength of a linear association between two variables, at a 95% confidence interval. When we look at the level of linear dependence between our two variables, both republicans (r=.726) and democrats (r=.966) have a strong correlation. Democrats correlation between deaths and cases is higher. 

Next, we completed a linear regression model to see if we can predict the value of an outcome (deaths) based on our predictor variable (cases). Our null hypothesis is that there is no relationship between the independent variable (deaths) and our dependent variable (cases). The alternative hypothesis is that the coefficients are not equal to zero.

```{r}
rep_lm <- glm(formula= Cases.per.thou~Deaths.per.thou, data=rep_data1)
summary(rep_lm)
```
```{r}
dem_lm <- glm(formula= Cases.per.thou~Deaths.per.thou , data=dem_data1)
summary(dem_lm)
```
Through these tests we see a statistical significance (p<.05) between these two linear models for republicans and democrats, allowing us to reject the null hypothesis that there is no relationship between cases and deaths for each party. We also see that republican (b=11.88 ) and democratic (b= 20.56) states have differing slopes, suggesting that the rate of deaths and cases for parties vary. 
```{r}
confint(rep_lm)
```
```{r}
confint(dem_lm)
```
To test if this difference was significant, we ran a confidence interval for each set of data (Figure 12-13). As the intervals lie just outside of each other, we can conclude with 95% confidence that the deaths and cases for each party are different. 

##3.4 Additional analysis including ANOVA, log and Poisson
```{r}
ggplot(data)+
  geom_point(aes(x = Democratic.advantage, y = ConfirmedRate))
ggplot(data)+
  geom_boxplot(aes(x = Classification, y = ConfirmedRate))
```

Before buliding models, we use plots to analyze the relationships among the major variables. We find that there is no clear relationship between democratic advantage and COVID-19 confirmed rate, but we do realize that, according to the boxplots, in states where Democratic and Republican are competitive, COVID-19 confirmed rates are slightly less than in other states. 

```{r}
data <- data %>%
  mutate(Inclination = ifelse(Democratic.advantage > 0, "Democratic",
                             ifelse(Democratic.advantage == 0, "Competitive", "Republican")))
ggplot(data)+
  geom_boxplot(aes(x = Inclination, y = ConfirmedRate))
```

To further justify that finding, we formulate a new variable called Inclination, which tells whether the democratic advantage is positive, negative, or strictly zero. In these new boxplots, we can see that competitive states have overall less confirmed rate than the other two groups, while the republican states have overall the most confirmed rate. 

```{r}
model1 <- lm(ConfirmedRate ~ Democratic.advantage, data = data)
summary(model1)
```

In Model1, we build a simple linear model that tells the relationship between the confirm rate (the number of confirmed COVID-19 case divided by population) and the Democratic advantage in vote. However, there is no significant correlation in these two variables. But we couldn't deny that there might be some relationship between these two variables after taking natural log of the confirmed rate. 

```{r}
data <- data %>%
  mutate(logCR = log(ConfirmedRate),
         logC = log(Confirmed))

ggplot(aes(x = Democratic.advantage, y = logCR), data = data)+
  geom_point()+
  geom_smooth(method = "lm", se = FALSE)+
  theme_classic()+
  labs(x = "Democratic Advantage (%)",
       y = "Logged confirmed rate")

ggplot(aes(x = Democratic.advantage, y = logC), data = data)+
  geom_point()+
  geom_smooth(method = "lm", se = FALSE, color = "red")+
  theme_classic()+
  labs(x = "Democratic Advantage (%)",
       y = "Logged number of confirmed case")
```

In the logged confirmed rate vs. Democratic advantage plot, the regression line has a positive slope, although the slope is not significant. In the logged number of confirmed case vs. Democratic advantage plot, we can observe a more significant slope that suggests a clear positive linear relationship between the logged number of confirmed case and Democratic advantage.


```{r}
model2 <- glm(Confirmed ~ Population + 
                Democratic.advantage, 
              family = "poisson", data = data)
summary(model2)
```

Since the number of confirmed COVID-19 case can be treated as count in a period of time (from Jan. 22nd to July 18th), we formulate a Possion model (Model2) having the number of confirmed case as its response variable, with population and democratic advatage as its explanatory variables. As we can see, each of the two variables are significant in 5% significance level. Also, there is no overdispersion in this model. 

```{r}
model3 <- glm(Confirmed ~ Population + Democratic.advantage + 
                Classification, family = "poisson", data = data)
summary(model3)
```

Based on Model2, we take the classification of Democratic inclination into consideration. It turns out that each level of classification is significant as an indicator variable.

```{r}
anova(model2, model3)
```

By running an ANOVA test, we know that Model3 is better than Model2 as it has less residual deviation.

```{r}
model4 <- glm(Confirmed ~ Population + Democratic.advantage + 
                Classification + Democratic.advantage:Classification, 
              family = "poisson", data = data)
anova(model3,model4)
```

Further, we add a correlated variable (Model4) to capture the relationship between the classification of Democratic inclination and the Democratic advantage in vote of each state. According to the ANOVA test, Model4 is the best model among all models we've built so far.


#4. Conclusion

#5. Citations 
